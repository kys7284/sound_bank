<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
 
<mapper namespace="com.boot.sound.fund.FundRepository">

    <!-- 펀드상품 목록 -->
    <select id="fundList" resultType="com.boot.sound.fund.FundDTO">
        SELECT * FROM fund_tbl
         ORDER BY fund_id ASC
    </select>
    
    <!-- 펀드상품 등록 -->
    <insert id="insertFund" parameterType="com.boot.sound.fund.FundDTO">
	    INSERT INTO fund_tbl(fund_name, fund_company, fund_type, fund_grade, fund_fee_rate, fund_upfront_fee, return_1m, return_3m, return_6m, return_12m)
	    VALUES (
	        #{fund_name},
	        #{fund_company},
	        #{fund_type},
	        #{fund_grade},
	        #{fund_fee_rate},
	        #{fund_upfront_fee},
	        #{return_1m},
	        #{return_3m},
	        #{return_6m},
	        #{return_12m}
	    )
	</insert>
	
	<!-- 등록된 펀드 상품 목록 조회 -->
    <select id="getRegisteredFunds" resultType="com.boot.sound.fund.FundDTO">
        SELECT * FROM fund_tbl
    </select>
    
    <!-- 펀드상품 상세보기 (1건 조회) -->
    <select id="findById" resultType="com.boot.sound.fund.FundDTO">
        SELECT * FROM fund_tbl
        WHERE fund_id = #{fund_id}
    </select>
    
    <!-- 펀드상품 수정 -->
    <update id="updateFund" parameterType="com.boot.sound.fund.FundDTO">
        UPDATE fund_tbl
        SET fund_name = #{fund_name},
            fund_company = #{fund_company},
            fund_type = #{fund_type},
            fund_grade = #{fund_grade},
            fund_fee_rate = #{fund_fee_rate},
            fund_upfront_fee = #{fund_upfront_fee},
            return_1m = #{return_1m},
            return_3m = #{return_3m},
            return_6m = #{return_6m},
            return_12m = #{return_12m}
        WHERE fund_id = #{fund_id}
    </update>
    
    <!-- 펀드상품 삭제 -->
    <delete id="deleteFund" parameterType="com.boot.sound.fund.FundDTO">
        DELETE FROM fund_tbl
        WHERE fund_id = #{fund_id, jdbcType=BIGINT}
    </delete>
    
    <!-- 투자 성향 테스트 결과 등록 -->
    <insert id="insertTestResult" parameterType="com.boot.sound.fund.FundTestDTO">
	    INSERT INTO fund_test_tbl(customer_id, fund_test_date, fund_risk_type)
	    VALUES (
	        #{customer_id},
	        DEFAULT,
	        #{fund_risk_type}
	    )
	</insert>
	
	<!-- 고객 정보에 투자성향 업데이트 -->
    <update id="updateRiskType">
        UPDATE CUSTOMER_TBL c
        SET CUSTOMER_RISK_TYPE = (
            SELECT fund_risk_type
            FROM fund_test_tbl f
            WHERE f.customer_id = c.customer_id
        )
        WHERE EXISTS (
            SELECT 1
            FROM fund_test_tbl f
            WHERE f.customer_id = c.customer_id
        )
    </update>

    <!-- 고객의 투자 성향 조회 -->
    <select id="getCustomerRiskType" parameterType="String" resultType="String">
        SELECT CUSTOMER_RISK_TYPE
        FROM CUSTOMER_TBL
        WHERE CUSTOMER_ID = #{customer_id}
    </select>

    <!-- 고객의 투자 성향에 맞는 펀드 목록 조회 -->
    <select id="recommendedFunds" parameterType="String" resultType="com.boot.sound.fund.FundDTO">
        SELECT f.*
        FROM FUND_TBL f
        JOIN FUND_TEST_TBL ft ON ft.fund_risk_type = #{fund_risk_type}
        JOIN CUSTOMER_TBL c ON c.customer_id = ft.customer_id
        WHERE c.customer_risk_type = #{fund_risk_type}
    </select>


</mapper>