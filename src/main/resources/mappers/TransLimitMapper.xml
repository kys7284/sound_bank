<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.sound.transfer.transLimit.TransLimitDAO">

  <!-- 고객 요청목록 -->
  <select id="getLimitList" resultType="com.boot.sound.transfer.transLimit.TransLimitDTO">
    SELECT
      t.transfer_id, t.customer_id, t.out_account_number, t.transfer_type,
      t.requested_limit, t.reason, t.request_date,
      a.approval_id, a.approval_type, a.status, a.reject_reason, a.approval_date
    FROM transfer_tbl t
    LEFT JOIN approval_tbl a ON t.transfer_id = a.transfer_id
    WHERE t.transfer_type = '한도'
      AND t.customer_id = #{customer_id}
    ORDER BY t.request_date DESC
  </select>

  <!-- 요청등록 -->
  <insert id="insertLimit" parameterType="com.boot.sound.transfer.transLimit.TransLimitDTO">
    INSERT INTO transfer_tbl (
      customer_id, out_account_number, transfer_type,
      requested_limit, reason, request_date
    ) VALUES (
      #{customer_id}, #{out_account_number}, '한도',
      #{requested_limit}, #{reason}, NOW()
    )
  </insert>

  <!-- 요청수정 -->
  <update id="updateLimit" parameterType="com.boot.sound.transfer.transLimit.TransLimitDTO">
    UPDATE transfer_tbl
    SET requested_limit = #{requested_limit},
        reason = #{reason}
    WHERE transfer_id = #{transfer_id}
  </update>

  <!-- 요청삭제 -->
  <delete id="deleteLimit" parameterType="int">
    DELETE FROM transfer_tbl
    WHERE transfer_id = #{transfer_id}
  </delete>
  
  <!-- 관리자 - 전체 요청목록 -->
  <select id="getAllLimitList" resultType="com.boot.sound.transfer.transLimit.TransLimitDTO">
    SELECT
      t.transfer_id, t.customer_id, t.out_account_number, t.transfer_type,
      t.requested_limit, t.reason, t.request_date,
      a.approval_id, a.approval_type, a.status, a.reject_reason, a.approval_date
    FROM transfer_tbl t
    LEFT JOIN approval_tbl a ON t.transfer_id = a.transfer_id
    WHERE t.transfer_type = '한도'
    ORDER BY t.request_date DESC
  </select>

  <!-- 관리자 - 승인 -->
  <insert id="approveLimit" parameterType="com.boot.sound.transfer.transLimit.TransLimitDTO">
    INSERT INTO approval_tbl (
      transfer_id, approval_type, status, approval_date
    ) VALUES (
      #{transfer_id}, '한도', '승인', NOW()
    )
  </insert>

  <!-- 관리자 - 거절 -->
  <insert id="rejectLimit" parameterType="com.boot.sound.transfer.transLimit.TransLimitDTO">
    INSERT INTO approval_tbl (
      transfer_id, approval_type, status, reject_reason, approval_date
    ) VALUES (
      #{transfer_id}, '한도', '거절', #{reject_reason}, NOW()
    )
  </insert>

</mapper>
